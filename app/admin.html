<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creative Hazard Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background-image: url('https://wallpaperaccess.com/full/1567784.jpg');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  margin:0;
  padding:20px;
  color:#333;
}
h1{color:white;text-align:center;text-shadow: 2px 2px 10px rgba(0,0,0,0.5);}
.summary{display:flex;gap:20px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;}
.card{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;padding:25px;border-radius:20px;
  flex:1 1 150px;text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover{transform:translateY(-10px);box-shadow:0 15px 35px rgba(0,0,0,0.4);}
.card h3{font-size:16px;margin-bottom:10px;}
.card p{font-size:28px;font-weight:bold;}
.report-container{
  max-height:500px;
  overflow-y:auto;
  padding:20px;
  border-radius:25px;
  background: linear-gradient(145deg, #ffffffcc, #f0f4ffcc);
  box-shadow:0 15px 35px rgba(0,0,0,0.1);
  margin-bottom:30px;
}
.report-container h2{
  margin-bottom:15px;
  font-size:1.5rem;
  text-align:center;
  color:#1e293b;
}
.report-card{
  background: linear-gradient(145deg,#fefefe,#e0e7ff);
  padding:15px;
  border-radius:20px;
  margin-bottom:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.report-card:hover{transform: translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.2);}
.report-card div{margin-bottom:8px;}
.status{font-weight:bold;padding:4px 10px;border-radius:12px;display:inline-block;}
.status.low{background: rgba(86,171,47,0.7); color:#fff;}
.status.moderate{background: rgba(255,179,71,0.8); color:#fff;}
.status.high{background: rgba(229,57,53,0.8); color:#fff;}
.btn{padding:6px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:5px;transition: transform 0.2s ease;}
.btn.approve{background:#28a745;color:white;}
.btn.reject{background:#e53935;color:white;}
.btn:hover{transform:scale(1.1);}
.chart-wrapper{display:flex;justify-content:center;gap:40px;margin-bottom:30px;flex-wrap:wrap;}
.chart-container{
  background:white;padding:20px;border-radius:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
  width:400px; height:400px;
}
.filter-card{display:flex;gap:15px;background: linear-gradient(135deg,#e0f7fa,#e1bee7);
  padding:15px;border-radius:15px;box-shadow:0 6px 20px rgba(0,0,0,0.1);flex-wrap:wrap;justify-content:center;margin-bottom:15px;}
.filter-card select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-weight:bold;}
img, video{max-width:100%; border-radius:8px; cursor:pointer;}
.media-container{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
#mediaModal { position: fixed; inset:0; background: rgba(0,0,0,0.75); display:flex; justify-content:center; align-items:center; z-index:50; display:none; }
#mediaContent { max-width:90%; max-height:90%; overflow:auto; }
#closeModal { position:absolute; top:10px; right:20px; font-size:3rem; color:white; cursor:pointer; }
</style>
</head>
<body>

<h1 class="text-4xl font-bold mb-6">Creative Hazard Admin Dashboard</h1>

<div class="summary">
  <div class="card"><h3>Total Reports</h3><p id="totalReports">0</p></div>
  <div class="card" style="background: linear-gradient(135deg,#22c55e,#16a34a);"><h3>Approved</h3><p id="approvedReports">0</p></div>
  <div class="card" style="background: linear-gradient(135deg,#f59e0b,#d97706);"><h3>Pending</h3><p id="pendingReports">0</p></div>
  <div class="card" style="background: linear-gradient(135deg,#ef4444,#b91c1c);"><h3>High Severity</h3><p id="dangerReports">0</p></div>
</div>

<div class="filter-card">
  <label for="locationFilter">Filter by Location:</label>
  <select id="locationFilter"><option value="">All Locations</option></select>
</div>

<div class="report-container" id="officialReportsContainer">
  <h2>Official Reports</h2>
</div>

<div class="report-container" id="citizenReportsContainer">
  <h2>Citizen Reports</h2>
</div>

<div class="chart-wrapper">
  <div class="chart-container">
    <h3 class="text-center">Reports by Location</h3>
    <canvas id="locationChart"></canvas>
  </div>
  <div class="chart-container">
    <h3 class="text-center">Reports by Status</h3>
    <canvas id="statusChart"></canvas>
  </div>
</div>

<!-- Modal for fullscreen media -->
<div id="mediaModal">
  <span id="closeModal">&times;</span>
  <div id="mediaContent"></div>
</div>

<script>
const API_BASE="http://127.0.0.1:8000";
let allReports=[], locationChart, statusChart;

// Fetch all reports
async function fetchReports(){
  try{
    const res = await fetch(`${API_BASE}/reports/admin`);
    allReports = await res.json();
    const official = allReports.filter(r=>r.is_official);
    const citizen = allReports.filter(r=>!r.is_official);
    populateReports("officialReportsContainer", official);
    populateReports("citizenReportsContainer", citizen, true);
    updateSummary(allReports);
    populateFilter(allReports);
    drawCharts(allReports);
  }catch(err){ console.error(err); }
}

// Populate reports
function populateReports(containerId, data, isAdmin=false){
  const container = document.getElementById(containerId);
  const heading = container.querySelector("h2").outerHTML;
  container.innerHTML = heading;

  data.forEach(r=>{
    // Handle files
    let files = Array.isArray(r.files)? r.files : [];
    if(typeof r.files==="string" && r.files.startsWith("[")){
      try{ files=JSON.parse(r.files); }catch(e){ files=[]; }
    }
    const createdAt = r.created_at ? new Date(r.created_at).toLocaleString() : "N/A";
    const severityClass = r.severity==="high"?"high":r.severity==="moderate"?"moderate":"low";

    let mediaHtml="";
    if(files.length){
      mediaHtml = `<div class="media-container">`+
        files.map(f=>{
          if(f.endsWith(".mp4")||f.endsWith(".mov"))
            return `<video src="${API_BASE}${f}" style="height:150px;cursor:pointer;" onclick="openMedia('${API_BASE}${f}','video')"></video>`;
          else
            return `<img src="${API_BASE}${f}" style="height:150px;cursor:pointer;" onclick="openMedia('${API_BASE}${f}','image')">`;
        }).join("")+`</div>`;
    }

    container.innerHTML += `
      <div class="report-card">
        <div style="display:flex;flex-wrap:wrap;gap:15px;">
          <div><strong>ID:</strong> ${r.id}</div>
          <div><strong>Hazard:</strong> ${r.hazard_type}</div>
          <div><strong>Location:</strong> ${r.location}</div>
          <div><strong>Description:</strong> ${r.description}</div>
          <div><strong>Status:</strong> <span class="status ${severityClass}">${r.status}</span></div>
          <div><strong>Severity:</strong> <span class="status ${severityClass}">${r.severity}</span></div>
          <div><strong>Time:</strong> ${createdAt}</div>
        </div>
        ${mediaHtml}
        ${isAdmin && r.status==="pending"?`<div style="margin-top:10px;">
          <button class="btn approve" onclick="updateStatus(${r.id},'approve')">Approve</button>
          <button class="btn reject" onclick="updateStatus(${r.id},'reject')">Reject</button>
        </div>`:""}
      </div>
    `;
  });
}

// Modal functions
const mediaModal=document.getElementById("mediaModal");
const mediaContent=document.getElementById("mediaContent");
const closeModal=document.getElementById("closeModal");
function openMedia(src,type="image"){
  mediaContent.innerHTML="";
  if(type==="image"){ const img=document.createElement("img"); img.src=src; img.style.width="100%"; img.style.height="auto"; mediaContent.appendChild(img);}
  else if(type==="video"){ const video=document.createElement("video"); video.src=src; video.controls=true; video.autoplay=true; video.style.width="100%"; video.style.height="auto"; mediaContent.appendChild(video);}
  mediaModal.style.display="flex";
}
closeModal.onclick=()=>{mediaModal.style.display="none"; mediaContent.innerHTML="";}
mediaModal.onclick=(e)=>{if(e.target===mediaModal){mediaModal.style.display="none"; mediaContent.innerHTML="";}}

// Update summary
function updateSummary(data){
  document.getElementById("totalReports").innerText = data.length;
  document.getElementById("approvedReports").innerText = data.filter(r=>r.status==="approved").length;
  document.getElementById("pendingReports").innerText = data.filter(r=>r.status==="pending").length;
  document.getElementById("dangerReports").innerText = data.filter(r=>r.severity==="high").length;
}

// Update report status
async function updateStatus(id, action){
  try{
    const res = await fetch(`${API_BASE}/reports/admin/${id}/${action}`,{method:"PUT"});
    if(!res.ok) throw new Error("Failed to update");
    fetchReports();
  }catch(err){ alert(err); console.error(err);}
}

// Charts
function drawCharts(data){
  const locCounts={};
  data.forEach(r=>locCounts[r.location]=(locCounts[r.location]||0)+1);
  const locCtx=document.getElementById("locationChart").getContext("2d");
  if(locationChart) locationChart.destroy();
  locationChart=new Chart(locCtx,{type:"pie",data:{labels:Object.keys(locCounts),datasets:[{data:Object.values(locCounts),backgroundColor:["#4f46e5","#22c55e","#f59e0b","#ef4444","#8b5cf6","#06b6d4"]}]},options:{responsive:false}});

  const statusCounts={approved:0,pending:0,rejected:0};
  data.forEach(r=>statusCounts[r.status]= (statusCounts[r.status]||0)+1);
  const statusCtx=document.getElementById("statusChart").getContext("2d");
  if(statusChart) statusChart.destroy();
  statusChart=new Chart(statusCtx,{type:"bar",data:{labels:Object.keys(statusCounts),datasets:[{label:"Reports",data:Object.values(statusCounts),backgroundColor:["#28a745","#ff9800","#e53935"]}]},options:{responsive:false,scales:{y:{beginAtZero:true}}}});
}

// Filter
function populateFilter(data){
  const select=document.getElementById("locationFilter");
  const locations=[...new Set(data.map(r=>r.location))];
  select.innerHTML='<option value="">All Locations</option>';
  locations.forEach(loc=>{select.innerHTML+=`<option value="${loc}">${loc}</option>`;});
}

document.getElementById("locationFilter").addEventListener("change",e=>{
  const filtered = e.target.value ? allReports.filter(r=>r.location===e.target.value) : allReports;
  const official = filtered.filter(r=>r.is_official);
  const citizen = filtered.filter(r=>!r.is_official);
  populateReports("officialReportsContainer", official);
  populateReports("citizenReportsContainer", citizen, true);
  updateSummary(filtered);
  drawCharts(filtered);
});

fetchReports();
</script>
</body>
</html>
